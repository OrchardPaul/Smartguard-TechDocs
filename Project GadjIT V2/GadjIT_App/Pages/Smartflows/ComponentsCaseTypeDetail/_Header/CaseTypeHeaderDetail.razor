@using GadjIT_App.Pages._Shared.Modals
@using GadjIT_ClientContext.Models.Smartflow.Client

@implements IDisposable

<div class="grid-chapter grid-casetype-smartflows">

    @if (LstSmartflows == null)
    {
        <div class="spinner"></div>
    }
    else
    {
      
        <div class="grid-actions">
            <div class="btn-group">
                <button @onclick='ShowCreateSmartflowModal' class="btn btn-main btn-shadow" title="Add new Smartflow"><i class="fa fa-plus pr-1"></i><span>New</span></button>
            </div>
        </div>


        <div class="grid-can-edit">
            
            <div class="grid-data grid-smartflow-list">
                <Dropzone Items="LstSmartflows"
                                    InstantReplace="true"
                                    OnItemDrop="@((sf)=>ReSequenceSmartFlows(LstSmartflows.IndexOf(sf) + 1))"
                                    OnDragStartParam="() => ResetRowChanged()"
                                    TItem="Client_VmSmartflowRecord">

                
                    <div class="row grid-row grid-row-lg @(context.ClientSmartflowRecord.SmartflowName.Contains("GROUP") ? "data-item-group" : "") @(RowChanged == context.ClientSmartflowRecord.SeqNo && !SeqMoving ? "row-changed" : "" )">
                        <div class="data-item ">
                            @if (UserSession.IsAdminUser)
                            {
                                @if (!CompareSystems)
                                {
                                    <div class="btn-ellipses float-left ">
                                        <span class="fa fa-ellipsis-v"></span>
                                        <div class="ellipsis-menu">
                                            <ul>
                                                <li class="col-main" @onclick="() => SelectSmartflow(context.ClientSmartflowRecord)" title="">
                                                    <span class="fa fa-pencil-alt mr-2"></span>
                                                    <span>Edit</span>
                                                </li>
                                                @if (!IsSmartflowLocked(context))
                                                {
                                                    <li class="col-main" @onclick='() => ShowSmartflowEditModal(context)' title="">
                                                        <span class="fa fa-font mr-2"></span>
                                                        <span>Rename</span>
                                                    </li>
                                                    <li class="col-red" @onclick='() => ShowSmartflowDeleteModal(context)' title="">
                                                        <span class="fa fa-trash-alt mr-2"></span>
                                                        <span>Delete</span>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="btn-ellipses float-left">
                                        @if (!(context.ComparisonIcon is null))
                                        {
                                            @if (!(context.ComparisonResult == "Exact match"))
                                            {
                                                <ModalTooltip Direction="right" Text=@(context.ComparisonResult == "Partial match" ? "Differences found, click to sync" : "Does not exist, click to create") Class="w-2">
                                                    <div class="btn-dashed" @onclick="() => ShowSmartflowSyncOnAltModal(context.ClientSmartflowRecord)"><span class="fa fa-@context.ComparisonIcon"></span></div>
                                                </ModalTooltip>

                                            }
                                            else
                                            {
                                                <ModalTooltip Direction="right" Text="Exact Match" Class="w-1">
                                                    <span class="fa fa-@context.ComparisonIcon"></span>
                                                </ModalTooltip>

                                            }
                                        }
                                        else
                                        {
                                            <div class="spinner"></div>
                                        }
                                    </div>
                                }

                            }
                            <div class="data-item-sub">
                                @context.ClientSmartflowRecord.SmartflowName
                                
                            </div>
                            <div class="data-item-right seq-change">
                                <div @onclick='() => MoveSmartFlowSeq(context.ClientSmartflowRecord, "Chapters", "Up")' class="@(@context.ClientSmartflowRecord.SeqNo == 1 ? "hidden" : "")"><span class="fa fa-angle-up"></span></div>
                                <div class="seq-no">@context.ClientSmartflowRecord.SeqNo</div>
                                <div @onclick='() => MoveSmartFlowSeq(context.ClientSmartflowRecord, "Chapters", "Down")' class="@(@context.ClientSmartflowRecord.SeqNo == LstSmartflows.Count() ? "hidden" : "")"><span class="fa fa-angle-down"></span></div>
                            </div>

                        </div>
                        <div class="data-item ">

                                @if(context.StatisticsStatus == "Set")
                                {
                                    <div class="@(context.NumAgenda > 0 ? "font-green" : "")">
                                        <div>
                                            <i class="fa fa-folder-open" Title="Agenda"></i>
                                        </div>
                                        @context.NumAgenda
                                    </div>
                                    <div class="@(context.NumStatus > 0 ? "font-green" : "")">
                                        <div>
                                            <i class="fa fa-battery-half" Title="Status"></i>
                                        </div>
                                        @context.NumStatus
                                    </div>
                                    <div class="@(context.NumDocs > 0 ? "font-green" : "")">
                                        <div>
                                            <i class="fa fa-file" Title="Documents"></i>
                                        </div>
                                        @context.NumDocs
                                    </div>
                                    <div class="@(context.NumFees > 0 ? "font-green" : "")">
                                        <div>
                                            <i class="fa fa-pound-sign" Title="Fees"></i>
                                        </div>
                                        @context.NumFees
                                    </div>
                                    <div class="@(context.NumDataViews > 0 ? "font-green" : "")">
                                        <div>
                                            <i class="fa fa-database" Title="Data Views"></i>
                                        </div>
                                        @context.NumDataViews
                                    </div>
                                    <div class="@(context.NumMessages > 0 ? "font-green" : "")">
                                        <div>
                                            <i class="fa fa-comment" Title="Messages"></i>
                                        </div>
                                        @context.NumMessages
                                    </div>

                                }
                            

                        </div>
                        <div class="data-item ">
                            @if(context.BackgroundImageName != null)
                            {
                                <img src="@context.BackgroundImage.Replace("/wwwroot","")" alt="" class="img-thumbnail" />

                            }

                        </div>
                        
                        <div class="data-item ">
                            @if(!IsSmartflowLocked(context))
                            {
                                <button class="btn btn-success" @onclick='() => SelectSmartflow(context.ClientSmartflowRecord)'>Edit</button>
                            }
                            else
                            {
                                <button title="Unlock Smartflow" class="btn btn-warning mr-2" @onclick='() => UnlockSmartflow(context)'><i class="fa-solid fa-lock-open"></i></button>
                                <button title="Smartflow is locked: view only" class="btn btn-success" @onclick='() => SelectSmartflow(context.ClientSmartflowRecord)'><i class="fa-solid fa-magnifying-glass"></i></button>
                            }

                        </div>
                        

                    </div>
                </Dropzone>

                

            </div>
        </div>
    }
</div>