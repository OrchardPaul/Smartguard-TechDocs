<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Serialization Strategy </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Serialization Strategy ">
    <meta name="generator" content="docfx 2.59.3.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    
    
  
    <!--FontAwesome-->
    <script src="../../styles/fontawesomev6/js/all.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  
  
    <style>
      .shadow { box-shadow: 0px 0px 8px #888; margin-top: 5px; margin-bottom: 5px;}
  
    </style>
      
  </head>
  
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.jpg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="serialization-strategy">Serialization Strategy</h1>

<h2 id="overview">Overview</h2>
<p>The SmartGuard models implement a comprehensive JSON serialization strategy that supports polymorphic types, maintains type safety, and provides robust error handling.</p>
<h2 id="serialization-flow">Serialization Flow</h2>
<pre><code class="lang-mermaid">flowchart TD
    A[Object Instance] --&gt; B[SerializeToJson()]
    B --&gt; C[GetSerializerOptions()]
    C --&gt; D[JsonSerializer.Serialize()]
    D --&gt; E[JSON String]
    E --&gt; F[Cache in DetailAsJson]
    F --&gt; G[Return JSON]
    
    style A fill:#e3f2fd
    style E fill:#e8f5e8
    style G fill:#fff3e0
</code></pre>
<h2 id="deserialization-flow">Deserialization Flow</h2>
<pre><code class="lang-mermaid">flowchart TD
    A[JSON String] --&gt; B[Factory.CreateDetailFromJson()]
    B --&gt; C[GetTypeFromJson()]
    C --&gt; D{Determine Type}
    D --&gt;|List| E[ORSG_QuestionDetailList]
    D --&gt;|Toggle| F[ORSG_QuestionDetailToggle]
    D --&gt;|Unknown| G[ORSG_QuestionDetailEmpty]
    E --&gt; H[DeserializeFromJson()]
    F --&gt; H
    G --&gt; H
    H --&gt; I[Concrete Instance]
    
    style A fill:#e3f2fd
    style I fill:#e8f5e8
</code></pre>
<h2 id="configuration">Configuration</h2>
<h3 id="jsonserializeroptions">JsonSerializerOptions</h3>
<pre><code class="lang-csharp">protected JsonSerializerOptions GetSerializerOptions() =&gt;
    new JsonSerializerOptions
    {
        PropertyNameCaseInsensitive = true,
        Converters = { new JsonStringEnumConverter() },
        WriteIndented = false,
        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
    };
</code></pre>
<h3 id="key-configuration-details">Key Configuration Details</h3>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Value</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PropertyNameCaseInsensitive</code></td>
<td><code>true</code></td>
<td>Handles different casing in JSON</td>
</tr>
<tr>
<td><code>JsonStringEnumConverter</code></td>
<td>Added</td>
<td>Serializes enums as strings</td>
</tr>
<tr>
<td><code>WriteIndented</code></td>
<td><code>false</code></td>
<td>Compact JSON for storage</td>
</tr>
<tr>
<td><code>DefaultIgnoreCondition</code></td>
<td><code>WhenWritingNull</code></td>
<td>Omit null properties</td>
</tr>
</tbody>
</table>
<h2 id="type-detection-strategy">Type Detection Strategy</h2>
<h3 id="json-type-detection">JSON Type Detection</h3>
<pre><code class="lang-csharp">public static QuestionType GetTypeFromJson(string json)
{
    if (string.IsNullOrEmpty(json))
        return QuestionType.Empty;

    try
    {
        using var document = JsonDocument.Parse(json);
        var root = document.RootElement;
        
        if (root.TryGetProperty(&quot;Type&quot;, out var typeElement))
        {
            if (Enum.TryParse&lt;QuestionType&gt;(typeElement.GetString(), true, out var questionType))
            {
                return questionType;
            }
        }
        
        return QuestionType.Empty;
    }
    catch (JsonException)
    {
        return QuestionType.Empty;
    }
}
</code></pre>
<h3 id="type-detection-flow">Type Detection Flow</h3>
<pre><code class="lang-mermaid">sequenceDiagram
    participant Client as Client
    participant Factory as Factory
    participant Parser as JSON Parser
    participant Enum as Enum Parser
    
    Client-&gt;&gt;Factory: GetTypeFromJson(json)
    Factory-&gt;&gt;Parser: JsonDocument.Parse(json)
    Parser--&gt;&gt;Factory: JsonDocument
    Factory-&gt;&gt;Parser: TryGetProperty(&quot;Type&quot;)
    Parser--&gt;&gt;Factory: TypeElement
    Factory-&gt;&gt;Enum: Enum.TryParse(value)
    Enum--&gt;&gt;Factory: QuestionType
    Factory--&gt;&gt;Client: QuestionType
</code></pre>
<h2 id="example-serialization-outputs">Example Serialization Outputs</h2>
<h3 id="orsg_questiondetaillist">ORSG_QuestionDetailList</h3>
<pre><code class="lang-json">{
  &quot;Options&quot;: [
    {
      &quot;Title&quot;: &quot;Strongly Agree&quot;,
      &quot;Description&quot;: &quot;I completely agree with this statement&quot;,
      &quot;Value&quot;: &quot;strongly-agree&quot;,
      &quot;Weight&quot;: 5
    },
    {
      &quot;Title&quot;: &quot;Agree&quot;, 
      &quot;Description&quot;: &quot;I generally agree with this statement&quot;,
      &quot;Value&quot;: &quot;agree&quot;,
      &quot;Weight&quot;: 4
    },
    {
      &quot;Title&quot;: &quot;Neutral&quot;,
      &quot;Description&quot;: &quot;I neither agree nor disagree&quot;,
      &quot;Value&quot;: &quot;neutral&quot;, 
      &quot;Weight&quot;: 3
    },
    {
      &quot;Title&quot;: &quot;Disagree&quot;,
      &quot;Description&quot;: &quot;I generally disagree with this statement&quot;,
      &quot;Value&quot;: &quot;disagree&quot;,
      &quot;Weight&quot;: 2
    },
    {
      &quot;Title&quot;: &quot;Strongly Disagree&quot;,
      &quot;Description&quot;: &quot;I completely disagree with this statement&quot;, 
      &quot;Value&quot;: &quot;strongly-disagree&quot;,
      &quot;Weight&quot;: 1
    }
  ],
  &quot;Default&quot;: &quot;neutral&quot;,
  &quot;SelectionMode&quot;: &quot;Single&quot;,
  &quot;ControlType&quot;: &quot;Radio&quot;,
  &quot;Direction&quot;: &quot;Vertical&quot;,
  &quot;Type&quot;: &quot;List&quot;,
  &quot;Position&quot;: &quot;Below&quot;
}
</code></pre>
<h3 id="orsg_questiondetailempty">ORSG_QuestionDetailEmpty</h3>
<pre><code class="lang-json">{
  &quot;Type&quot;: &quot;Empty&quot;,
  &quot;Position&quot;: &quot;Below&quot;
}
</code></pre>
<h2 id="error-handling">Error Handling</h2>
<h3 id="deserialization-error-handling">Deserialization Error Handling</h3>
<pre><code class="lang-csharp">public override ORSG_QuestionDetailList DeserializeFromJson(string json)
{
    if (string.IsNullOrEmpty(json))
        return new ORSG_QuestionDetailList();

    try
    {
        var result = JsonSerializer.Deserialize&lt;ORSG_QuestionDetailList&gt;(
            json, 
            GetSerializerOptions()
        );
        
        // Validate deserialized result
        if (result == null)
            return new ORSG_QuestionDetailList();
            
        // Ensure arrays are never null
        result.Options ??= Array.Empty&lt;ListOption&gt;();
        result.Default ??= string.Empty;
        
        return result;
    }
    catch (JsonException ex)
    {
        // Log error details
        System.Diagnostics.Debug.WriteLine($&quot;Deserialization failed: {ex.Message}&quot;);
        return new ORSG_QuestionDetailList();
    }
}
</code></pre>
<h3 id="error-handling-strategy">Error Handling Strategy</h3>
<pre><code class="lang-mermaid">flowchart TD
    A[Deserialize Request] --&gt; B{Valid JSON?}
    B --&gt;|No| C[Return Default Instance]
    B --&gt;|Yes| D[Attempt Deserialization]
    D --&gt; E{Success?}
    E --&gt;|No| F[Log Error]
    E --&gt;|Yes| G[Validate Result]
    F --&gt; C
    G --&gt; H{Valid Object?}
    H --&gt;|No| C
    H --&gt;|Yes| I[Return Deserialized Object]
    
    style C fill:#ffebee
    style I fill:#e8f5e8
</code></pre>
<h2 id="performance-considerations">Performance Considerations</h2>
<h3 id="caching-strategy">Caching Strategy</h3>
<pre><code class="lang-csharp">public abstract class ORSG_QuestionDetail
{
    private string _cachedJson;
    private bool _isDirty = true;
    
    protected string DetailAsJson 
    { 
        get =&gt; _cachedJson ?? &quot;&quot;;
        set 
        {
            _cachedJson = value;
            _isDirty = false;
        }
    }
    
    public virtual string SerializeToJson()
    {
        if (_isDirty || string.IsNullOrEmpty(_cachedJson))
        {
            _cachedJson = JsonSerializer.Serialize(this, GetSerializerOptions());
            _isDirty = false;
        }
        return _cachedJson;
    }
    
    protected void MarkDirty() =&gt; _isDirty = true;
}
</code></pre>
<h3 id="performance-metrics">Performance Metrics</h3>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Cold Performance</th>
<th>Cached Performance</th>
</tr>
</thead>
<tbody>
<tr>
<td>Serialization</td>
<td>~2ms</td>
<td>~0.1ms</td>
</tr>
<tr>
<td>Deserialization</td>
<td>~3ms</td>
<td>N/A</td>
</tr>
<tr>
<td>Type Detection</td>
<td>~1ms</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<h2 id="validation">Validation</h2>
<h3 id="json-schema-validation">JSON Schema Validation</h3>
<pre><code class="lang-csharp">public static bool ValidateQuestionJson(string json, QuestionType expectedType)
{
    try
    {
        var actualType = GetTypeFromJson(json);
        if (actualType != expectedType)
            return false;
            
        // Attempt deserialization to validate structure
        var detail = ORSG_QuestionDetailFactory.CreateDetailFromJson(json);
        return !(detail is ORSG_QuestionDetailEmpty) || expectedType == QuestionType.Empty;
    }
    catch
    {
        return false;
    }
}
</code></pre>
<h3 id="required-properties-validation">Required Properties Validation</h3>
<pre><code class="lang-csharp">public static ValidationResult ValidateListQuestionJson(string json)
{
    var result = new ValidationResult();
    
    try
    {
        using var document = JsonDocument.Parse(json);
        var root = document.RootElement;
        
        // Validate required properties
        if (!root.TryGetProperty(&quot;Type&quot;, out _))
            result.Errors.Add(&quot;Missing required property: Type&quot;);
            
        if (!root.TryGetProperty(&quot;Options&quot;, out var optionsElement))
            result.Errors.Add(&quot;Missing required property: Options&quot;);
        else if (optionsElement.ValueKind != JsonValueKind.Array)
            result.Errors.Add(&quot;Options must be an array&quot;);
        else if (optionsElement.GetArrayLength() == 0)
            result.Errors.Add(&quot;Options array cannot be empty&quot;);
            
        // Validate each option
        if (optionsElement.ValueKind == JsonValueKind.Array)
        {
            int index = 0;
            foreach (var option in optionsElement.EnumerateArray())
            {
                ValidateOptionElement(option, index, result);
                index++;
            }
        }
    }
    catch (JsonException ex)
    {
        result.Errors.Add($&quot;Invalid JSON: {ex.Message}&quot;);
    }
    
    return result;
}

private static void ValidateOptionElement(JsonElement option, int index, ValidationResult result)
{
    if (!option.TryGetProperty(&quot;Title&quot;, out _))
        result.Errors.Add($&quot;Option {index}: Missing Title property&quot;);
        
    if (!option.TryGetProperty(&quot;Value&quot;, out _))
        result.Errors.Add($&quot;Option {index}: Missing Value property&quot;);
}
</code></pre>
<h2 id="migration-strategy">Migration Strategy</h2>
<h3 id="version-compatibility">Version Compatibility</h3>
<pre><code class="lang-csharp">public class VersionCompatibilityHandler
{
    public string MigrateToCurrentVersion(string json, string fromVersion)
    {
        return fromVersion switch
        {
            &quot;1.0&quot; =&gt; MigrateFrom1_0(json),
            &quot;1.1&quot; =&gt; MigrateFrom1_1(json),
            _ =&gt; json // Current version or unknown
        };
    }
    
    private string MigrateFrom1_0(string json)
    {
        // Handle migration from version 1.0
        // Example: Add default values for new properties
        var document = JsonDocument.Parse(json);
        var options = new JsonSerializerOptions { WriteIndented = true };
        
        using var stream = new MemoryStream();
        using var writer = new Utf8JsonWriter(stream);
        
        writer.WriteStartObject();
        
        foreach (var property in document.RootElement.EnumerateObject())
        {
            property.WriteTo(writer);
        }
        
        // Add new properties with defaults
        if (!document.RootElement.TryGetProperty(&quot;SelectionMode&quot;, out _))
        {
            writer.WriteString(&quot;SelectionMode&quot;, &quot;Single&quot;);
        }
        
        writer.WriteEndObject();
        writer.Flush();
        
        return Encoding.UTF8.GetString(stream.ToArray());
    }
}
</code></pre>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong><a href="https://www.orchardrock.co.uk" target="_blank" title="Orchard Rock Development website">Orchard Rock Development</a></strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    
    <script>
    mermaid.initialize({
    startOnLoad: false
    });
    mermaid.init(undefined, ".lang-mermaid");
    </script>  </body>
</html>
