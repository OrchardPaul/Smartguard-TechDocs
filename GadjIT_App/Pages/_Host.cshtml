@page "/"
@namespace GadjIT_App.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    Layout = null;
}

@using Microsoft.AspNetCore.Authorization
@using Services.SessionState
@inject IUserSessionState sessionState
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor _HttpContext
@{
    _HttpContext.HttpContext.Response.Headers["Cache-Control"] = "no-store";
}

@attribute [Authorize]

<script>

    @* Backimg = new Image()
    Backimg.src = "/css/images/GhostImages/DocDragGhost2.jpg";


    function ShowModal(modalId) {
        $('#' + modalId).modal('show');
        $('#' + modalId).appendTo(document.body);
    }

    function CloseModal(modalId) {
        $('#' + modalId).modal('hide');
    }

    function HideAll() {
        $('.modal').modal('hide');
    }

    function DownloadTextFile(filename, fileContent) {
        var link = document.createElement('a');
        link.download = filename;
        link.href = "data:application/octet-stream;base64," + fileContent;
        document.body.appendChild(link); // Needed for Firefox
        link.click();
        document.body.removeChild(link);
    }

    function moveToPosition(position) {
        var el = document.getElementById('mainScroll');
        el.scrollTop = position;
    }

    function getElementPosition() {
        var el = document.getElementById('mainScroll');
        return el.scrollTop;
    }

    function addEventListener(elementId) {
        var el = document.getElementById(elementId);
        if (el) {
            el.addEventListener("dragstart", function (e) {
                e.dataTransfer.setDragImage(Backimg, 0, 0);
            }, false);

        }
    }

    function loadDataTable(tableId) {

        $(tableId).DataTable({

                dom: 'Bflrtip',

                retrieve: true,

                buttons: [

                    'copyHtml5',

                    'excelHtml5',

                    'csvHtml5',

                    'pdfHtml5'

                ],

                pagingType: "full_numbers",

                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],

                autoWidth: false,

                scrollX: true,

                order: []

        });

    }

    function destroyDataTable(tableId) {

        const table = $(tableId).DataTable();

        table.destroy();


    } *@


</script>
<style>
    #coverup {
        background: white;
        width: 170px;
        height: 100px;
        position: absolute;
        top: 0;
        right: 0;
        z-index: 2;
    }
</style>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GadjIT</title>
    <base href="~/" />
    <!-- Font awesome links -->  
    <script src="~/fontawesomev6/js/all.js"></script>
    <link href="~/fontawesomev6/css/all.css" rel="stylesheet" />
    


    <script src="~/jquery/jquery.min.js"></script>

    <script src="~/bootstrap/dist/js/bootstrap.js"></script>
    <link href="~/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />
    @*<link href="_content/Blazored.Modal/blazored-modal.css" rel="stylesheet" />*@

    @* <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"> *@
    <link href="~/css/Custom/Fade.css" rel="stylesheet" />
    <link href="~/css/site.css" rel="stylesheet" />
    <link href="~/css/Custom/OR_Custom.css" rel="stylesheet" />
    <link href="~/css/Custom/OR_Modal.css" rel="stylesheet" />
    <link href="~/css/Custom/OR_Nav.css" rel="stylesheet" />
    <link href="~/css/Custom/OR_Text.css" rel="stylesheet" />
    <link href="~/css/Custom/OR_Dropdown.css" rel="stylesheet" />
    <link href="~/css/Custom/OR_Table.css" rel="stylesheet" />

    <script src="~/js/custom.js"></script>


    <script src="https://github.com/Daddoon/Blazor.Polyfill/releases/download/3.0.1/blazor.polyfill.min.js"></script>

    @* <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css" /> *@
    @* <script type="text/javascript" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script> *@

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    @* <script type="text/javascript" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js"></script> *@


    <!--COLOR PICKER-->
    <link href="_content/BlazorColorPicker/colorpicker.css" rel="stylesheet" />
    <script src="_content/BlazorColorPicker/colorpicker.js"></script>

</head>


<body>
    <div id="components-reconnect-modal" class="my-reconnect-modal components-reconnect-hide">
        <div class="show">
            <div>
                <div>
                    <p>Attempting to reconnect to the server:&nbsp
                        <span id="components-reconnect-current-attempt"></span> /
                        <span id="components-reconnect-max-retries"></span>
                    </p> 
                    <p class="font-85">Try reloading the page</p>
                    <div><button class="btn btn-main reload" onclick="javascript:window.location.reload();">Reload</button></div>
                </div>
                <div class="spinner"></div>
            </div>
        </div>
        <div class="failed">
            <div>
                <div>
                    <p>Lost connect with the server, maybe a network issue. </p>
                    <p class="font-85">Try reloading the page.</p>
                    <div><button class="btn btn-main reload" onclick="javascript:window.location.reload();">Reload</button></div>
                </div>
            </div>
        </div>
        <div class="rejected">
            <div>
                <div>
                    <p>Lost connect with the server, possibly timed out. </p>
                    <p class="font-85">Try reloading the page.</p>
                    <div><button class="btn btn-main reload" onclick="javascript:window.location.reload();">Reload</button></div>
                </div>
            </div>
        </div>
    </div>
    
    <app>
        <component type="typeof(App)" render-mode="ServerPrerendered" />
    </app>

    <div id="blazor-error-ui">
        <environment include="Staging,Production">
            <div>
                <div>This application is reloading or requires a reload.</div>
                <a href="" class="btn btn-main reload">Reload</a>
                <a class="dismiss">🗙</a>
            </div>
        </environment>
        <environment include="Development">
            <div>
                <div>An error has occurred. This application may no longer respond until reloaded.</div>
                <a href="" class="btn btn-main reload">Reload</a>
                <a class="dismiss">🗙</a>
            </div>
        </environment>
    </div>

    @* <script src="_framework/blazor.server.js"></script> *@
    <script src="_framework/blazor.server.js" autostart="false"></script>
    <script>
        Blazor.start({
            reconnectionOptions: {
            maxRetries: 10,
            retryIntervalMilliseconds: 8000
            }
        });
    </script>
    <script src="_content/BlazorInputFile/inputfile.js"></script>
    @*<script src="_content/Blazored.Modal/blazored.modal.js"></script>*@


    <script src="~/jquery/custom/blazored.modal.js"></script>

    
    <script>
        const reconnectModal = document.querySelector('#components-reconnect-modal'); 
        var reloadAttepmts = 0;
        var reloadInterval = 3000; //3 secs
        var firstReloadEnd = 5;
        var secondReloadInterval = 20000; //20 secs
        var secondReloadEnd = 2;
        var intervalID;
        const options = {
                        attributes: true
                        };
        
        function callback(mutationList, observer) {

            mutationList.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if(reconnectModal.classList.contains('components-reconnect-show')) //whilst Blazor attempts to reconnect
                    {
                        if(reloadAttepmts === 0)
                        {
                            observer.disconnect();
                            attemptReload();
                            console.info("First Reload Attepmt");

                            intervalID = setInterval(attemptReload, reloadInterval); //check rapidly (every 2 seconds) for better user experience when first lost connection
                        
                        }
                        
                    }

                }
            })
        };

        async function attemptReload() {
            reloadAttepmts += 1;
            if(reloadAttepmts === firstReloadEnd)
            {
                clearInterval(intervalID);
                reloadInterval = secondReloadInterval;
                intervalID = setInterval(attemptReload, reloadInterval);
            }
            if(reloadAttepmts === secondReloadEnd)
            {
                clearInterval(intervalID);
            }
            console.info("Reload Attepmts: " + reloadAttepmts.toString() + " - next attempt in " + (reloadInterval/1000).toString() + " seconds.");
            await fetch(''); // Check the server really is back
            location.reload();
        }
        
        const observer = new MutationObserver(callback);
        observer.observe(reconnectModal, options); 
    </script>

    @*<script type="text/javascript">

            function fncPrepDataTables() {
                //var table = $('#tbl_Export').DataTable({
                //    // "sDom": '<"#divTableButtons"l><"top"<"clear">>t<"bottom"ip<"clear">f>',
                //    "sDom": "<'row'<'col-sm-5'B><'col-sm-5'l><'col-sm-2'f>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-6'i><'col-sm-6'p>>",
                //    "buttons": [
                //        'csv', 'excel'
                //    ],
                //    //"pagingType": "full_numbers",
                //    //"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                //    //"scrollX": true

                //})
                var table = $('#tbl_Export').DataTable();

                new $.fn.dataTable.Buttons(table, {
                    buttons: [
                        'copy', 'excel', 'csv'
                    ]
                });

                table.buttons().container().appendTo('.datatable-buttons');

            }



        </script>*@

</body>
</html>
