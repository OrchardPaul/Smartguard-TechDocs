@page "/Smartflows"
@page "/Smartflow"
@page "/Smartflow/{UrlCaseTypeGroup}/{UrlCaseType}/{UrlChapter}"
@page "/Smartflow/{UrlCaseTypeGroup}/{UrlCaseType}"

@inject IJSRuntime jsRuntime
@using Gizmo_V1_02.Pages.Shared.Modals
@using System.Globalization;


@if (ListChapterLoaded == false)
{
    <div class="spinner"></div>
}
else
{

    @if (selectedChapter.Name == "" | selectedChapter.Name is null)
    {
        <div class="tran-block page-header-block ">
            <h3>Smartflow</h3>
            <p class="hidden-md-down">Create and maintain Smartflows for all case types. <em>Note: please make sure you are pointing to the appropriate system.</em></p>
        </div>

        <div class="mb-4 grid-tran grid-chapter-nav">
            <div class="tran-block rounded">
                @if (sessionState.isAdminUser)
                {
                    <div class="grid-actions">
                        <div class="btn-group">
                            <button @onclick='PrepareChapterForInsert' class="btn btn-main btn-shadow" title="Add new Smartflow"><i class="fa fa-plus pr-1"></i><span>New Smartflow</span></button>
                            @if (!(string.IsNullOrEmpty(selectedChapter.CaseType)))
                            {
                                @if (!(SequenceIsValid("Chapters")))
                                {
                                    <button @onclick='() => CondenseChapterSeq()' class="btn btn-main btn-shadow" title="Re-order Sequence Numbers"><i class="fa fa-sort-numeric-down"></i></button>

                                }
                            }
                        </div>
                        <div class="btn-group">
                            <button @onclick='(() => PrepareForExport(lstChapters, "Chapter Export"))' class="btn btn-main btn-shadow" title="Export data to Excel or CSV"><i class="fa fa-file-export"></i><span class="pl-2">Export</span></button>
                        </div>
                        <div class="spacer"></div>
                        @if (sessionState.isAdminUser)
                        {
                            <div class="btn-group sync-group invisible-sm-down">
                                <input type="checkbox" class="ml-1 mt-1" @onchange="() => CompareAllChapters()" /><span class="ml-2 font-75">Compare to @(sessionState.selectedSystem == "Dev" ? "Live" : "Dev") </span>
                            </div>

                        }
                    </div>

                }
                <div class="container-fluid">

                    <!-- SHOW ALL GROUPS -->
                    @foreach (var caseTypeGroup in lstChapters.Where(C => C.ChapterObject.ParentId == 0)
                    .Where(C => !(C.ChapterObject.CaseTypeGroup is null))
                    .Select(C => C.ChapterObject.CaseTypeGroup)
                    .Distinct()
                    .ToList())
                    {

                        <div class="grid-row-lg mt-3 nav-row-1">
                            <div class="data-item" title="Group: click to see case types assigned to @caseTypeGroup">
                                @if (sessionState.isAdminUser)
                                {
                                    <div class="btn-ellipses float-left">
                                        <span class="fa fa-ellipsis-v"></span>
                                        <div class="ellipsis-menu" style="margin-top: 20px">
                                            <ul>
                                                <li class="col-main" @onclick='() => PrepareCaseTypeForEdit(caseTypeGroup, "CaseTypeGroup")'>
                                                    <span class="fa fa-font mr-2"></span>
                                                    <span>Rename</span>
                                                </li>

                                            </ul>
                                        </div>
                                    </div>
                                }

                                <div class="data-item-nav" @onclick='() => SelectCaseTypeGroup(caseTypeGroup)'>
                                    <div class="data-item-sub"><span class="fa fa-boxes mr-2"></span>@caseTypeGroup</div>
                                    <div class="data-item-right col-alt"><div class="link-direction @(caseTypeGroup == selectedChapter.CaseTypeGroup ? "triangle-up " : "triangle-down")"></div></div>
                                </div>
                            </div>


                        </div>



                        <!-- GROUP SELECTED SHOW CASE TYPES-->
                        @if (caseTypeGroup == selectedChapter.CaseTypeGroup)
                        {

                            @foreach (var caseType in lstChapters.Where(C => C.ChapterObject.ParentId == 0)
                             .Where(C => !(C.ChapterObject.CaseType is null))
                             .Where(C => C.ChapterObject.CaseTypeGroup == selectedChapter.CaseTypeGroup)
                             .Select(C => C.ChapterObject.CaseType)
                             .Distinct()
                             .ToList())
                            {

                                <div class="grid-row-md nav-row-2">
                                    <div class="data-item" title="Case Type: click to see the Smartflows within @caseType">
                                        @if (sessionState.isAdminUser)
                                        {
                                            <div class="btn-ellipses float-left">
                                                <span class="fa fa-ellipsis-v"></span>
                                                <div class="ellipsis-menu">
                                                    <ul>
                                                        <li class="col-main" @onclick='() => PrepareCaseTypeForEdit(caseType, "CaseType")'>

                                                            <span class="fa fa-font mr-2"></span>
                                                            <span>Rename</span>

                                                        </li>

                                                    </ul>
                                                </div>
                                            </div>
                                        }
                                        <div class="data-item-nav" @onclick='() => SelectCaseType(caseType)'>
                                            @if (caseType == selectedChapter.CaseType)
                                            {
                                                <div class="data-item-sub">
                                                    <span class="fa fa-folder-open mr-2"></span>@caseType
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="data-item-sub">
                                                    <span class="fa fa-folder mr-2"></span>@caseType
                                                </div>
                                            }


                                            <div class="data-item-right col-alt "><div class="link-direction @(caseType == selectedChapter.CaseType ? "triangle-up " : "triangle-down")"></div></div>
                                        </div>
                                    </div>

                                </div>
                                @if (caseType == selectedChapter.CaseType)
                                {
                                    <div class="grid-nav">
                                        @foreach (var Chapter in lstChapters
                                                 .Where(C => C.ChapterObject.CaseType == selectedChapter.CaseType)
                                                 .Where(C => C.ChapterObject.CaseTypeGroup == selectedChapter.CaseTypeGroup)
                                                 .Where(C => C.ChapterObject.Type == "Chapter")
                                                 .OrderBy(C => C.ChapterObject.SeqNo)
                                                 .ToList())
                                        {
                                            <div class="grid-row-md nav-row-3 no-border  @(rowChanged == Chapter.ChapterObject.SeqNo ? ToggleRowChangedClass() : "" )">
                                                <div class="data-item @(Chapter.ChapterObject.Name.Length > 6 && Chapter.ChapterObject.Name.Substring(0,6) == "GROUP " ? "data-item-group" : "")">

                                                    @if (sessionState.isAdminUser)
                                                    {
                                                        @if (!compareSystems)
                                                        {
                                                            <div class="btn-ellipses float-left ">
                                                                <span class="fa fa-ellipsis-v"></span>
                                                                <div class="ellipsis-menu">
                                                                    <ul>
                                                                        <li class="col-main" @onclick='() => PrepareChapterForEdit(Chapter.ChapterObject, "Chapter")' title="">
                                                                            <span class="fa fa-font mr-2"></span>
                                                                            <span>Rename</span>
                                                                        </li>
                                                                        <li class="col-main" @onclick="() => SelectChapter(Chapter.ChapterObject)" title="">
                                                                            <span class="fa fa-pencil-alt mr-2"></span>
                                                                            <span>Edit</span>
                                                                        </li>
                                                                        <li class="col-red" @onclick='() => PrepareChapterDelete(Chapter)' title="">
                                                                            <span class="fa fa-trash-alt mr-2"></span>
                                                                            <span>Delete</span>
                                                                        </li>
                                                                    </ul>
                                                                </div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="btn-ellipses float-left">
                                                                @if (!(Chapter.ComparisonIcon is null))
                                                                {
                                                                    @if (!(Chapter.ComparisonResult == "Exact match"))
                                                                    {
                                                                        <div class="btn-dashed" @onclick="() => PrepareChapterCreateOnAlt(Chapter.ChapterObject)"><span class="fa fa-@Chapter.ComparisonIcon"></span></div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="fa fa-@Chapter.ComparisonIcon"></span>
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    <div class="spinner"></div>
                                                                }
                                                            </div>
                                                        }

                                                    }
                                                    <div class="data-item-sub">
                                                        <span class="hidden-sm-down"><span class=" fa fa-share-alt-square mr-2"></span></span>
                                                        @Chapter.ChapterObject.Name
                                                    </div>
                                                    @if (sessionState.isAdminUser)
                                                    {
                                                        <div class="data-item-right seq-change">
                                                            <div @onclick='() => MoveSeq(Chapter.ChapterObject, "Chapters", "Up")'><span class="fa fa-angle-up"></span></div>
                                                            <div class="seq-no">@Chapter.ChapterObject.SeqNo</div>
                                                            <div @onclick='() => MoveSeq(Chapter.ChapterObject, "Chapters", "Down")'><span class="fa fa-angle-down"></span></div>
                                                        </div>
                                                    }
                                                    <div title="Chapter: click to configure @Chapter.ChapterObject.Name" class="data-item-right link-direction" @onclick="() => SelectChapter(Chapter.ChapterObject)">
                                                        <div class="fa fa-chevron-circle-right"></div>
                                                    </div>
                                                </div>
                                            </div>

                                        }
                                    </div>

                                }

                            }
                        }
                    }
                </div>
            </div>
        </div>
    }
}

@if (selectedChapter.Name != "" & !(selectedChapter.Name is null))
{

    <div class="tran-block page-header-block ">
        <div class="page-header-title">
            <div class="float-left back-link" @onclick="SelectHome">
                <span class="col-alt fa fa-angle-double-left"></span>
            </div>
            <h3>Smartflow: @selectedChapter.Name</h3>
        </div>
        <p class="hidden-md-down">Group: <span class="badge badge-grey mr-3">@selectedChapter.CaseTypeGroup</span> Case Type: <span class="badge badge-grey mr-3">@selectedChapter.CaseType</span> Smartflow: <span class="badge badge-grey mr-3"> @selectedChapter.Name</span></p>
    </div>

    <div class="tran-block rounded">
        <div class="tran-navbar hidden-lg-down">
            <nav class="navbar navbar-expand ">

                <ul class="navbar-nav">
                    <li class="nav-item @(navDisplay == "Chapter" ? "active" : "")" @onclick='() => ShowNav("Chapter")'>
                        <span class="font-120"><span class="fa fa-home" Title="Home - main Smartflow settings"></span></span>

                    </li>
                    <li class="nav-item @(navDisplay == "Agenda" ? "active" : "")" @onclick='() => ShowNav("Agenda")'>
                        <span class="font-120"><span class="fa fa-folder-open" Title="Agenda (Progress Files) - make available documents from file history"></span></span>
                        <div class="subtitle">Agenda</div>
                    </li>
                    <li class="nav-item  @(navDisplay == "Status" ? "active" : "")" @onclick='() => ShowNav("Status")'>
                        <span class="font-120"><span class="fa fa-battery-half" Title="Status - Smartflow status options to track progress"></span></span>
                        <div class="subtitle">Status</div>
                    </li>
                    <li class="nav-item @(navDisplay == "Docs" ? "active" : "")" @onclick='() => ShowNav("Docs")'>
                        <span class="font-120"><span class="fa fa-file" Title="Documents and Steps - list documents and create workflow"></span></span>
                        <div class="subtitle">Docs</div>
                    </li>
                    <li class="nav-item @(navDisplay == "Fees" ? "active" : "")" @onclick='() => ShowNav("Fees")'>
                        <span class="font-120"><span class="fa fa-pound-sign" Title="Fees and Disbursements"></span></span>
                        <div class="subtitle">Fees</div>
                    </li>
                    <li class="nav-item @(navDisplay == "DataViews" ? "active" : "")" @onclick='() => ShowNav("DataViews")'>
                        <span class="font-120"><span class="fa fa-database" Title="Data Views - Managing Partner views to be available on Smartflow screen"></span></span>
                        <div class="subtitle">Data</div>
                    </li>
                    <li class="nav-item @(navDisplay == "TickerMessages" ? "active" : "")" @onclick='() => ShowNav("TickerMessages")'>
                        <span class="font-120"><span class="fa fa-comment" Title="Messages - create ticker messages to inform users of updates or pending changes"></span></span>
                        <div class="subtitle">Messages</div>
                    </li>
                    <li class="nav-item @(navDisplay == "Background" ? "active" : "")" @onclick='() => ShowNav("Background")'>
                        <span class="font-120"><span class="fa fa-image" Title="Background - set background colour or image"></span></span>
                        <div class="subtitle">Background</div>
                    </li>
                    @if ((sessionState.isAdminUser))
                    {
                        <li class="nav-item @(navDisplay == "Backups" ? "active" : "")" @onclick='() => ShowNav("Backups")'>
                            <span class="font-120"><span class="fa fa-save" Title="Backups - save, download and restore"></span></span>
                            <div class="subtitle">Backups</div>
                        </li>
                    }

                </ul>

            </nav>
        </div>

        <div class="page-navbar hidden-xl-up">
            <ul class="nav nav-pills tran-tabs">
                <li class="nav-item @(navDisplay == "Chapter" ? "active" : "")" @onclick='() => ShowNav("Chapter")'>
                    <span class="font-120"><span class="fa fa-home" Title="Home - main Smartflow settings"></span></span>
                    <div class="subtitle">Home</div>
                </li>
                <li class="nav-item @(navDisplay == "Agenda" ? "active" : "")" @onclick='() => ShowNav("Agenda")'>
                    <span class="font-120"><span class="fa fa-folder-open" Title="Agenda (Progress Files) - make available documents from file history"></span></span>
                    <div class="subtitle">Agenda</div>
                </li>
                <li class="nav-item  @(navDisplay == "Status" ? "active" : "")" @onclick='() => ShowNav("Status")'>
                    <span class="font-120"><span class="fa fa-battery-half" Title="Status - Smartflow status options to track progress"></span></span>
                    <div class="subtitle">Status</div>
                </li>
                <li class="nav-item @(navDisplay == "Docs" ? "active" : "")" @onclick='() => ShowNav("Docs")'>
                    <span class="font-120"><span class="fa fa-file" Title="Documents and Steps - list documents and create workflow"></span></span>
                    <div class="subtitle">Docs</div>
                </li>
                <li class="nav-item @(navDisplay == "Fees" ? "active" : "")" @onclick='() => ShowNav("Fees")'>
                    <span class="font-120"><span class="fa fa-pound-sign" Title="Fees and Disbursements"></span></span>
                    <div class="subtitle">Fees</div>
                </li>
                <li class="nav-item @(navDisplay == "DataViews" ? "active" : "")" @onclick='() => ShowNav("DataViews")'>
                    <span class="font-120"><span class="fa fa-database" Title="Data Views - Managing Partner views to be available on Smartflow screen"></span></span>
                    <div class="subtitle">Data</div>
                </li>
                <li class="nav-item @(navDisplay == "TickerMessages" ? "active" : "")" @onclick='() => ShowNav("TickerMessages")'>
                    <span class="font-120"><span class="fa fa-comment" Title="Messages - create ticker messages to inform users of updates or pending changes"></span></span>
                    <div class="subtitle">Msg</div>
                </li>

            </ul>

        </div>

        @if (displaySpinner)
        {
            <div class="spinner"></div>
        }
        else
        {

            @if (navDisplay == "Chapter")
            {

                <div class="grid-chapter grid-chapter-chapter">
                    <div class="grid-actions">

                        <div class="btn-group">
                            <button @onclick='(() => ExportSmartflowToExcel())' class="btn btn-main btn-shadow" title="Export Smartflow Details"><i class="fa fa-file-export"></i><span>Export</span></button>
                        </div>
                        @if ((sessionState.isAdminUser))
                        {
                            <div class="invisible-md-down btn-group">
                                <button @onclick='(() => ShowChapterImportModel())' class="btn btn-main btn-shadow" title="Import Smartflow Details"><i class="fa fa-file-import"></i><span>Import</span></button>
                                <button @onclick='PrepareChapterForCopy' class="btn btn-main btn-shadow" title="Copy Smartflow"><i class="fa fa-paste"></i><span>Copy</span></button>
                                <button @onclick="() => PrepareHeaderForComparison()" class="btn btn-main btn-shadow" title="Sync To @(sessionState.selectedSystem == "Dev" ? "Live" : "Dev")"><i class="fa fa-sync"></i><span>Sync</span></button>
                            </div>
                        }


                    </div>

                    <div class="mb-3 flex-box">

                        <div class="detail-group-box">

                            @if ((sessionState.isAdminUser))
                            {

                                <EditForm Model="selectedChapter" OnValidSubmit="SaveChapterDetails">
                                    <div class="row">
                                        <div class="col-12 col-xl-6">
                                            <div class="form-group">
                                                <label for="P4WCTG">P4W Case Type Group</label>
                                                <InputSelect class="form-control form-control-xxl"
                                                             ValueExpression="@(() => selectedChapter.P4WCaseTypeGroup)"
                                                             Value="@selectedChapter.P4WCaseTypeGroup"
                                                             ValueChanged="@((string value) => SaveP4WCaseTypeGroup(value))">
                                                    <option value="">Select</option>
                                                    @foreach (var group in partnerCaseTypeGroups)
                                                    {
                                                        <option value="@group.Name">
                                                            @group.Name
                                                        </option>
                                                    }
                                                </InputSelect>
                                            </div>
                                            <div class="form-group">
                                                <label for="SelectedView">Smartflow View</label>
                                                <InputSelect class="form-control form-control-xxl"
                                                             ValueExpression="@(() => selectedChapter.SelectedView)"
                                                             Value="@selectedChapter.SelectedView"
                                                             ValueChanged="@((string value) => SaveSelectedView(value))">
                                                    <option value="">Select</option>
                                                    @foreach (var view in ListP4WViews.Where(V => !(V.InternalNote is null) && (V.InternalNote.Contains("Smartflow"))).ToList())
                                                    {
                                                        <option value="@view.Name">
                                                            @view.Name
                                                        </option>
                                                    }
                                                </InputSelect>
                                            </div>
                                            @if (!(selectedChapter.SelectedStep is null) && selectedChapter.SelectedStep != "Create New")
                                            {
                                                <div class="form-group">
                                                    <label for="SelectedStep">Smartflow Step</label>
                                                    <InputSelect class="form-control form-control-xxl"
                                                                 ValueExpression="@(() => selectedChapter.SelectedStep)"
                                                                 Value="@selectedChapter.SelectedStep"
                                                                 ValueChanged="@((string value) => SaveSelectedStep(value))">
                                                        <option value="">Select</option>
                                                        <option value="Create New">--- Create New ---</option>
                                                        @foreach (var step in dropDownChapterList.Where(D => D.DocumentType == 6).Where(D => D.Notes.Contains("Smartflow:")).ToList())
                                                        {
                                                            <option value="@step.Name">
                                                                @step.Name
                                                            </option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="form-group">
                                                    <label>Enter Smartflow Step Name</label>
                                                    <InputText @bind-Value="selectedChapter.StepName" class="form-control form-control-xxl" />
                                                </div>
                                                <button @onclick='(() => CreateP4WSmartflowStep())' class="btn btn-main btn-shadow" title="Create Step"><span>Create</span></button>
                                                <button @onclick='(() => CancelCreateP4WStep())' class="btn btn-main btn-shadow" title="Cancel"><span>Cancel</span></button>
                                            }

                                        </div>
                                        <div class="col-12 col-xl-6">
                                            <div class="form-group">
                                                <label>Background Colour</label>

                                                @if (!string.IsNullOrEmpty(selectedChapter.BackgroundColourName))
                                                {
                                                    <div @onclick='() => ShowNav("Background")' class="thumbnail-item rounded nav-link" style="height: 35px; background-color: @getHTMLColourFromAndroid(selectedChapter.BackgroundColour)">
                                                        @selectedChapter.BackgroundColourName
                                                    </div>


                                                }
                                                else
                                                {
                                                    <div @onclick='() => ShowNav("Background")' class="nav-link" style="height: 35px; width: 240px; margin-left: 10px; border: 1pt solid #ccc; padding-left: 10px; padding-right: 10px">

                                                        <label class="col-grey ml-2">No background colour selected</label>

                                                    </div>
                                                }
                                                <div class="mt-3 link-item" style="height: 100px; margin: 0; padding: 0;" @onclick='() => ShowNav("Background")'>

                                                    @if (!string.IsNullOrEmpty(selectedChapter.BackgroundImageName))
                                                    {

                                                        <label class="d-block">Selected Background Image</label>
                                                        <img src="@selectedChapter.BackgroundImage.Replace("/wwwroot","")" alt="" class="img-thumbnail ml-2" />


                                                    }
                                                    else
                                                    {
                                                        <label class="d-block">No background image selected</label>
                                                        <img src="/images/BackgroundImages/NoImage.jpg" alt="" class="img-thumbnail ml-2" />

                                                    }
                                                </div>

                                            </div>

                                            <div class="form-group hidden-lg-down">
                                                <label style="display: inline-block; width: 150px">Preview Image</label>
                                                <label class="switch">
                                                    <input type="checkbox" @bind="PreviewChapterImage">
                                                    <span class="slider round"></span>
                                                </label>
                                            </div>

                                            <div class="form-group">
                                                <label style="display: inline-block; width: 150px">Show Notes</label>
                                                <label class="switch">
                                                    <input type="checkbox" @bind="PartnerShowNotes">
                                                    <span class="slider round"></span>
                                                </label>
                                            </div>

                                            @*<div class="form-group">
                                                <label>Ticker Message</label>
                                                <InputTextArea @bind-Value="selectedChapter.GeneralNotes" class="form-control form-control-xxl" />
                                            </div>*@
                                        </div>
                                    </div>

                                    <!--
                                <div class="form-group">
                                    <label>Developer Notes</label>
                                    <InputTextArea @bind-Value="selectedChapter.DeveloperNotes" class="form-control form-control-lg" />
                                </div>
                                -->

                                    
                                </EditForm>


                            }
                            else
                            {

                                <div class="form-group">
                                    <label>Smartflow Name: </label>
                                    <label class="form-control-value">@selectedChapter.Name</label>
                                </div>
                                <div class="form-group">
                                    <label>Background Colour:</label>
                                    <label class="form-control-value" style="background-color: @getHTMLColourFromAndroid(selectedChapter.BackgroundColour)">
                                        @ListChapterColours.Where(C => C.ColourCode == @selectedChapter.BackgroundColour).Select(C => C.ColourName).SingleOrDefault()
                                    </label>
                                </div>

                            }
                        </div>

                    </div>
                </div>
            }

            @if (navDisplay == "Docs")
            {

                <div class="grid-chapter grid-chapter-docs">

                    <div class="grid-actions">

                        @if (!compareSystems)
                        {
                            @if (sessionState.isAdminUser)
                            {
                                <div class="btn-group">
                                    <button @onclick='() => PrepareForInsert(navDisplay, "Steps and Documents")' class="btn btn-main btn-shadow" title="Add new document/step"><i class="fa fa-plus"></i><span>New</span></button>

                                    <button @onclick='() => CondenseSeq("Docs")' class="btn btn-main btn-shadow @(SequenceIsValid("Docs") ? "invisible" : "")" title="Re-order Sequence Numbers"><i class="fa fa-sort-numeric-down"></i></button>
                                </div>
                            }

                        }
                        <ModalTooltip Direction="top shift-right" Text="Documents and steps to be made available in the chapter for inserting into the case agenda!">
                            <span class="info-icon">
                                <span class=" fa fa-info-circle fa-2x "></span>
                            </span>
                        </ModalTooltip>
                        <div class="spacer">
                        </div>
                        @if (sessionState.isAdminUser)
                        {
                            <div class="btn-group sync-group invisible-md-down">
                                <button type="button" @onclick="() => PrepareChapterSync()" class="btn btn-main btn-shadow @(!compareSystems ? "hidden" : "")" title="Sync To @(sessionState.selectedSystem == "Dev" ? "Live" : "Dev")"><i class="fa fa-sync"></i><span>Sync</span></button>
                                <input type="checkbox" class="ml-1 mt-1" @onchange="() => ToggleComparison()" /><span class="ml-2 font-75 ">Compare to @(sessionState.selectedSystem == "Dev" ? "Live" : "Dev") </span>
                            </div>
                        }
                    </div>



                    <div class="@(sessionState.isAdminUser ? "grid-can-edit" : "") ">
                        <div class="row grid-header invisible-md-down">
                            <div class="data-item ">
                                <div class="data-item-sub">
                                    Name
                                </div>
                            </div>
                            <div class="data-item ">
                                <div class="data-item-sub">
                                    Schedule
                                </div>
                            </div>
                            <div class="data-item ">
                                <div class="data-item-sub">
                                    On Completion
                                </div>
                            </div>
                        </div>
                        <div class="grid-data">
                            @foreach (var doc in lstDocs)
                            {

                                <div class="row grid-row grid-row-lg @(rowChanged == doc.ChapterObject.SeqNo ? "row-changed" : "" )">
                                    <div class="data-item ">

                                        @if (sessionState.isAdminUser && !compareSystems)
                                        {
                                            <div class="btn-ellipses float-left">
                                                <span class="fa fa-ellipsis-v"></span>

                                                <div class="ellipsis-menu">
                                                    <ul>
                                                        <li class="col-main" @onclick='(() => PrepareForEdit(doc, "Steps and Documents"))'>
                                                            <span class="fa fa-pencil-alt mr-2"></span>
                                                            <span>Edit</span>
                                                        </li>
                                                        <li class="col-main" @onclick='(() => ShowChapterDetailViewModal(doc, "Steps and Documents"))'>
                                                            <span class="fa fa-binoculars mr-2"></span>
                                                            <span>View</span>
                                                        </li>
                                                        <li class="col-main" @onclick='(() => PrepareAttachmentForEdit(doc, "Steps and Documents"))'>
                                                            <span class="fa fa-paperclip mr-2"></span>
                                                            <span>Attachments</span>
                                                        </li>
                                                        <li class="col-red" @onclick="() => PrepareChapterDetailDelete(doc)">
                                                            <span class="fa fa-trash-alt mr-2"></span>
                                                            <span>Delete</span>
                                                        </li>

                                                    </ul>
                                                </div>
                                            </div>
                                        }
                                        else if (sessionState.isAdminUser && compareSystems)
                                        {
                                            <div class="btn-ellipses float-left">
                                                @if (!(doc.ComparisonIcon is null))
                                                {
                                                    @if (!(doc.ComparisonResult == "Exact match"))
                                                    {
                                                        <div class="btn-dashed" @onclick="() => PrepareForComparison(doc)"><span class="fa fa-@doc.ComparisonIcon"></span></div>
                                                    }
                                                    else
                                                    {
                                                        <span class="fa fa-@doc.ComparisonIcon"></span>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="spinner"></div>
                                                }

                                            </div>
                                        }
                                        else
                                        {
                                            <div class="btn-ellipses float-left">
                                                <span class="fa fa-ellipsis-v"></span>

                                                <div class="ellipsis-menu">
                                                    <ul>
                                                        <li class="col-main" @onclick='(() => ShowChapterDetailViewModal(doc, "Steps and Documents"))'>
                                                            <span class="fa fa-binoculars mr-2"></span>
                                                            <span>View</span>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        }

                                        <div class="data-item-sub " title="@doc.DocDisplayName">
                                            <span class="font-100">
                                                <!--"Doc", "Letter", "Form", "Email", "Step"-->
                                                @switch (doc.DocType)
                                                {
                                                    case "Doc":
                                                        <span class="fa fa-file mr-2"></span>
                                                        break;
                                                    case "Letter":
                                                        <span class="fa fa-file-alt mr-2"></span>
                                                        break;
                                                    case "Form":
                                                        <span class="fa fa-file-pdf mr-2"></span>
                                                        break;
                                                    case "Email":
                                                        <span class="fa fa-envelope mr-2"></span>
                                                        break;
                                                    case "Step":
                                                        <span class="fa fa-list-ol mr-2"></span>
                                                        break;
                                                    default:
                                                        <span class="fa fa-times mr-2"></span>
                                                        break;
                                                }
                                            </span>
                                            @doc.DocDisplayName
                                        </div>

                                        @if (doc.DocOrigName != "")
                                        {
                                            <div class="data-item-right hidden-md-down">
                                                <ModalTooltip Direction="top" Text=@("Template: " + doc.DocOrigName) Class="w-3">
                                                    <span class="fa fa-clone"></span>
                                                </ModalTooltip>
                                            </div>
                                        }

                                        @if (!string.IsNullOrEmpty(doc.ChapterObject.PopupAlert))
                                        {
                                            <div class="data-item-right hidden-md-down">
                                                <ModalTooltip Direction="top" Text=@("POPUP: " + doc.ChapterObject.PopupAlert) Class="w-3">
                                                    <span class="fa fa-exclamation-triangle"></span>
                                                </ModalTooltip>
                                            </div>
                                        }

                                        @if (!string.IsNullOrEmpty(doc.ChapterObject.UserMessage))
                                        {
                                            <div class="data-item-right hidden-md-down">
                                                <ModalTooltip Direction="top" Text=@("NOTES: " + doc.ChapterObject.UserMessage) Class="w-3">
                                                    <span class="fa fa-comment"></span>
                                                </ModalTooltip>
                                            </div>
                                        }

                                        @if (!(doc.ChapterObject.FollowUpDocs is null))
                                        {
                                            <div class="data-item-right hidden-md-down">
                                                <ModalTooltip Direction="left" Text=@($"This document will {doc.ChapterObject.FollowUpDocs.FirstOrDefault().Action.ToLower()} the following: {doc.ChapterObject.FollowUpDocs.FirstOrDefault().DocName}.")>
                                                    <span class="fa fa-paperclip"></span>
                                                </ModalTooltip>
                                            </div>
                                        }

                                        @if (sessionState.isAdminUser && !compareSystems)
                                        {
                                            <div class="data-item-right seq-change">
                                                <div @onclick='() => MoveSeq(doc.ChapterObject, "Docs", "Up")'><span class="fa fa-angle-up"></span></div>
                                                <div class="seq-no">@doc.ChapterObject.SeqNo</div>
                                                <div @onclick='() => MoveSeq(doc.ChapterObject, "Docs", "Down")'><span class="fa fa-angle-down"></span></div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="data-item-right mr-2 ">
                                                <div class="seq-no">@doc.ChapterObject.SeqNo</div>
                                            </div>
                                        }
                                    </div>
                                    <div class="hidden-md-down data-item ">
                                        <div class="data-item-sub font-85 pl-3" title="@(string.IsNullOrEmpty(doc.ChapterObject.AsName) ? "" : doc.ChapterObject.AsName)">@(string.IsNullOrEmpty(doc.ChapterObject.AsName) ? "" : doc.ChapterObject.AsName)</div>

                                        @if (doc.ChapterObject.RescheduleDays.HasValue & !(doc.ChapterObject.RescheduleDays == 0))
                                        {
                                            <div class="data-item-right schedule-days">
                                                <ModalTooltip Direction="left" Text="@(string.IsNullOrEmpty(doc.ChapterObject.AsName) ? "" : "The step named " + doc.ChapterObject.AsName + " will be scheduled for " + doc.ChapterObject.RescheduleDays.ToString() + " days")">
                                                    <span class="badge rounded-square">@doc.ChapterObject.RescheduleDays.ToString()d</span>
                                                </ModalTooltip>
                                            </div>
                                        }

                                    </div>
                                    <div class="hidden-md-down data-item ">
                                        @if (!(string.IsNullOrEmpty(doc.ChapterObject.CompleteName)))
                                        {
                                            <div class="data-item-sub font-85 pl-3" title="This document will be saved in the agenda as @doc.ChapterObject.CompleteName.">
                                                @doc.ChapterObject.CompleteName
                                            </div>

                                        }
                                        else
                                        {
                                            <div class="data-item-sub">
                                            </div>
                                        }

                                        @if (!(string.IsNullOrEmpty(doc.ChapterObject.NextStatus)))
                                        {
                                            @if (lstStatus.Where(S => S.ChapterObject.Name == doc.ChapterObject.NextStatus).Select(S => S.ChapterObject.SuppressStep).SingleOrDefault() == "Y")
                                            {
                                                <div class="data-item-right suppress-step">
                                                    <ModalTooltip Direction="left" Text="This document will end the Smartflow when taken.">
                                                        <span class="fa fa-flag-checkered"></span>
                                                    </ModalTooltip>
                                                </div>
                                            }


                                            <div class="data-item-right suppress-step">
                                                <ModalTooltip Direction="left" Text=@("Status Change: " + doc.ChapterObject.NextStatus)>
                                                    <span class="fa fa-battery-half"></span>
                                                </ModalTooltip>
                                            </div>
                                        }


                                    </div>

                                </div>

                            }
                        </div>
                    </div>
                </div>

            }

            @if (navDisplay == "Agenda")
            {

                <div class="grid-chapter grid-chapter-agenda">


                    <div class="grid-actions">

                        @if (!compareSystems)
                        {
                            <div class="btn-group">
                                @if (sessionState.isAdminUser)
                                {
                                    <button @onclick='() => PrepareForInsert(navDisplay, "Agenda")' class="btn btn-main btn-shadow" title="Add new agenda"><i class="fa fa-plus"></i><span>New</span></button>
                                }
                            </div>
                        }
                        <ModalTooltip Direction="top" Text="Correspondence stored in these agendas will be made avalible on the History tab.">
                            <span class="info-icon">
                                <span class=" fa fa-info-circle fa-2x "></span>
                            </span>
                        </ModalTooltip>
                        <div class="spacer">
                        </div>
                        @if (sessionState.isAdminUser)
                        {
                            <div class="btn-group sync-group invisible-md-down">
                                <button type="button" @onclick="() => PrepareChapterSync()" class="btn btn-main btn-shadow @(!compareSystems ? "hidden" : "")" title="Sync To @(sessionState.selectedSystem == "Dev" ? "Live" : "Dev")"><i class="fa fa-sync"></i><span>Sync</span></button>
                                <input type="checkbox" class="ml-1 mt-1" @onchange="() => ToggleComparison()" /><span class="ml-2 font-75 ">Compare to @(sessionState.selectedSystem == "Dev" ? "Live" : "Dev") </span>
                            </div>
                        }
                    </div>

                    <div class="@(sessionState.isAdminUser ? "grid-can-edit" : "") ">

                        @foreach (var agenda in lstAgendas)
                        {

                            <div class="row grid-row">
                                <div class="col-12 data-item">
                                    @if (sessionState.isAdminUser)
                                    {

                                        @if (!compareSystems)
                                        {
                                            <div class="btn-ellipses float-left">
                                                <span class="fa fa-ellipsis-v"></span>
                                                <div class="ellipsis-menu">
                                                    <ul>
                                                        <li class="col-main" @onclick='(() => PrepareForEdit(agenda, "Agenda"))'>
                                                            <span class="fa fa-pencil-alt mr-2"></span>
                                                            <span>Edit</span>
                                                        </li>
                                                        <li class="col-main" @onclick='(() => ShowChapterDetailViewModal(agenda, "Agenda"))'>
                                                            <span class="fa fa-binoculars mr-2"></span>
                                                            <span>View</span>
                                                        </li>
                                                        <li class="col-red" @onclick="() => PrepareChapterDetailDelete(agenda)">
                                                            <span class="fa fa-trash-alt mr-2"></span>
                                                            <span>Delete</span>
                                                        </li>

                                                    </ul>

                                                </div>
                                            </div>
                                        }
                                        else
                                        {

                                            <div class="btn-ellipses float-left">
                                                @if (!(agenda.ComparisonIcon is null))
                                                {
                                                    @if (!(agenda.ComparisonResult == "Exact match"))
                                                    {
                                                        <div class="btn-dashed" @onclick="() => PrepareForComparison(agenda)"><span class="fa fa-@agenda.ComparisonIcon"></span></div>
                                                    }
                                                    else
                                                    {
                                                        <span class="fa fa-@agenda.ComparisonIcon"></span>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="spinner"></div>
                                                }

                                            </div>
                                        }

                                    }
                                    else
                                    {
                                        <div class="btn-ellipses float-left">
                                            <span class="fa fa-ellipsis-v"></span>
                                            <div class="ellipsis-menu">
                                                <ul>
                                                    <li class="col-main" @onclick='(() => ShowChapterDetailViewModal(agenda, "Agenda"))'>
                                                        <span class="fa fa-binoculars mr-2"></span>
                                                        <span>View</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    }
                                    <div class="data-item-sub">
                                        <span class="font-100"><span class="fa fa-folder-open mr-2"></span></span>@agenda.ChapterObject.Name
                                    </div>
                                </div>

                            </div>

                        }
                    </div>
                </div>

            }

            @if (navDisplay == "Fees")
            {

                <div class="grid-chapter grid-chapter-fees">

                    <div class="grid-actions">

                        @if (!compareSystems)
                        {
                            @if (sessionState.isAdminUser)
                            {
                                <div class="btn-group">
                                    <button @onclick='() => PrepareFeeForInsert("Insert")' class="btn btn-main btn-shadow" title="Add new fee"><i class="fa fa-plus"></i><span>New</span></button>
                                    <button @onclick='() => CondenseFeeSeq("Fees")' class="btn btn-main btn-shadow @(FeeSeqNoIsValid() ? "invisible" : "")" title="Re-order Sequence Numbers"><i class="fa fa-sort-numeric-down"></i></button>
                                </div>
                            }

                        }
                        <ModalTooltip Direction="top" Text="Fees to be made available in the Smartflow. Default values will be automatically calculated where possible.">
                            <span class="info-icon">
                                <span class=" fa fa-info-circle fa-2x "></span>
                            </span>
                        </ModalTooltip>
                        <div class="spacer">
                        </div>
                        @if (sessionState.isAdminUser)
                        {
                            <div class="btn-group sync-group invisible-md-down">
                                <button type="button" @onclick="() => PrepareChapterSync()" class="btn btn-main btn-shadow @(!compareSystems ? "hidden" : "")" title="Sync To @(sessionState.selectedSystem == "Dev" ? "Live" : "Dev")"><i class="fa fa-sync"></i><span>Sync</span></button>
                                <input type="checkbox" class="ml-1 mt-1" @onchange="() => ToggleFeeComparison()" /><span class="ml-2 font-75 ">Compare to @(sessionState.selectedSystem == "Dev" ? "Live" : "Dev") </span>
                            </div>
                        }
                    </div>

                    <div class="@(sessionState.isAdminUser ? "grid-can-edit" : "") ">
                        <div class="row grid-header invisible-md-down">
                            <div class="data-item ">
                                <div class="data-item-sub">
                                    Name
                                </div>
                            </div>
                            <div class="data-item ">
                                <div class="data-item-sub">
                                    Category
                                </div>
                            </div>
                            <div class="data-item ">
                                <div class="data-item-sub">
                                    Posting Type
                                </div>
                            </div>
                            <div class="data-item ">
                                <div class="data-item-sub text-right">
                                    Amount
                                </div>
                            </div>
                        </div>
                        @foreach (var fee in lstFees.OrderBy(F => F.FeeObject.SeqNo).ToList())
                        {
                            <div class="row grid-row grid-row-lg @(rowChanged == fee.FeeObject.SeqNo ? "row-changed" : "" )">
                                <div class="data-item">
                                    @if (sessionState.isAdminUser)
                                    {
                                        @if (!compareSystems)
                                        {
                                            <div class="btn-ellipses float-left">
                                                <span class="fa fa-ellipsis-v"></span>
                                                <div class="ellipsis-menu">
                                                    <ul>
                                                        <li class="col-main" @onclick='(() => ShowChapterFeesModal("Edit", fee.FeeObject))'>
                                                            <span class="fa fa-pencil-alt mr-2"></span>
                                                            <span>Edit</span>
                                                        </li>
                                                        <li class="col-main" @onclick='(() => ShowChapterFeeViewModal(fee))'>
                                                            <span class="fa fa-binoculars mr-2"></span>
                                                            <span>View</span>
                                                        </li>
                                                        <li class="col-red" @onclick="() => PrepareChapterFeeDelete(fee)">
                                                            <span class="fa fa-trash-alt mr-2"></span>
                                                            <span>Delete</span>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <div class="data-item-sub">
                                                <span class="fa fa-pound-sign mr-2"></span> @fee.FeeObject.FeeName
                                            </div>

                                            @if (fee.FeeObject.VATable == "Y")
                                            {
                                                <div class="data-item-right hidden-md-down">
                                                    <ModalTooltip Direction="top" Text=@("VAT Included") Class="w-3">
                                                        <span class="fa fa-coins"></span>
                                                    </ModalTooltip>
                                                </div>
                                            }

                                            <div class="data-item-right seq-change">
                                                <div @onclick='() => MoveFeeSeqNo(fee.FeeObject, "Fees", "Up")'><span class="fa fa-angle-up"></span></div>
                                                <div class="seq-no">@fee.FeeObject.SeqNo</div>
                                                <div @onclick='() => MoveFeeSeqNo(fee.FeeObject, "Fees", "Down")'><span class="fa fa-angle-down"></span></div>
                                            </div>

                                        }
                                        else
                                        {

                                            <div class="btn-ellipses float-left">
                                                @if (!(fee.ComparisonIcon is null))
                                                {
                                                    @if (!(fee.ComparisonResult == "Exact match"))
                                                    {
                                                        <div class="btn-dashed" @onclick="() => PrepareFeeForComparison(fee)"><span class="fa fa-@fee.ComparisonIcon"></span></div>
                                                    }
                                                    else
                                                    {
                                                        <span class="fa fa-@fee.ComparisonIcon"></span>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="spinner"></div>
                                                }

                                            </div>


                                            <div class="data-item-sub">
                                                <span class="fa fa-pound-sign mr-2"></span> @fee.FeeObject.FeeName
                                            </div>
                                            @if (fee.FeeObject.VATable == "Y")
                                            {
                                                <div class="data-item-right hidden-md-down">
                                                    <ModalTooltip Direction="top" Text=@("VAT Included") Class="w-3">
                                                        <span class="fa fa-coins"></span>
                                                    </ModalTooltip>
                                                </div>
                                            }
                                            <div class="data-item-right seq-change">
                                                <div class="seq-no">@fee.FeeObject.SeqNo</div>
                                            </div>
                                        }
                                    }
                                    else
                                    {

                                        <div class="btn-ellipses float-left">
                                            <span class="fa fa-ellipsis-v"></span>
                                            <div class="ellipsis-menu">
                                                <ul>
                                                    <li class="col-main" @onclick='(() => ShowChapterFeeViewModal(fee))'>
                                                        <span class="fa fa-binoculars mr-2"></span>
                                                        <span>View</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                        <div class="data-item-sub">
                                            <span class="fa fa-pound-sign mr-2"></span> @fee.FeeObject.FeeName
                                        </div>
                                        @if (fee.FeeObject.VATable == "Y")
                                        {
                                            <div class="data-item-right hidden-md-down">
                                                <ModalTooltip Direction="top" Text=@("VAT Included") Class="w-3">
                                                    <span class="fa fa-coins"></span>
                                                </ModalTooltip>
                                            </div>
                                        }
                                        <div class="data-item-right seq-change">
                                            <div class="seq-no">@fee.FeeObject.SeqNo</div>
                                        </div>
                                    }

                                </div>
                                <div class="hidden-md-down data-item ">
                                    <div class="data-item-sub font-85 pl-3">@fee.FeeObject.FeeCategory</div>
                                </div>
                                <div class="hidden-md-down data-item ">
                                    <div class="data-item-sub font-85 pl-3">@fee.FeeObject.PostingType</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-item-sub text-right font-85 pl-3">£@string.Format("{0:N2}", fee.FeeObject.Amount)</div>
                                </div>
                            </div>

                        }
                    </div>
                </div>

            }

            @if (navDisplay == "Status")
            {

                <div class="grid-chapter grid-chapter-status">
                    <div class="grid-actions">

                        @if (!compareSystems)
                        {
                            @if (sessionState.isAdminUser)
                            {
                                <div class="btn-group">
                                    <button @onclick='() => PrepareForInsert(navDisplay, "Status")' class="btn btn-main btn-shadow" title="Add new status"><i class="fa fa-plus"></i><span>New</span></button>
                                    <button @onclick='() => CondenseSeq("Status")' class="btn btn-main btn-shadow @(SequenceIsValid("Status") ? "invisible" : "")" title="Re-order Sequence Numbers"><i class="fa fa-sort-numeric-down"></i></button>
                                </div>
                            }

                        }
                        <ModalTooltip Direction="top" Text="Status options to assist with the flow of the Smartflow and to indicate when the Smartflow is complete">
                            <span class="info-icon">
                                <span class=" fa fa-info-circle fa-2x "></span>
                            </span>
                        </ModalTooltip>
                        <div class="spacer">
                        </div>
                        @if (sessionState.isAdminUser)
                        {
                            <div class="btn-group sync-group invisible-md-down">
                                <button type="button" @onclick="() => PrepareChapterSync()" class="btn btn-main btn-shadow @(!compareSystems ? "hidden" : "")" title="Sync To @(sessionState.selectedSystem == "Dev" ? "Live" : "Dev")"><i class="fa fa-sync"></i><span>Sync</span></button>
                                <input type="checkbox" class="ml-1 mt-1" @onchange="() => ToggleComparison()" /><span class="ml-2 font-75 ">Compare to @(sessionState.selectedSystem == "Dev" ? "Live" : "Dev") </span>
                            </div>
                        }
                    </div>
                    <div class="@(sessionState.isAdminUser ? "grid-can-edit" : "") ">

                        @foreach (var status in lstStatus)
                        {

                            <div class="row grid-row @(rowChanged == status.ChapterObject.SeqNo ? "row-changed" : "" )">
                                <div class="col-12 data-item">
                                    @if (sessionState.isAdminUser)
                                    {
                                        @if (!compareSystems)
                                        {
                                            <div class="btn-ellipses float-left">
                                                <span class="fa fa-ellipsis-v"></span>
                                                <div class="ellipsis-menu">
                                                    <ul>
                                                        <li class="col-main" @onclick='(() => PrepareForEdit(status, "Status"))'>
                                                            <span class="fa fa-pencil-alt mr-2"></span>
                                                            <span>Edit</span>
                                                        </li>
                                                        <li class="col-main" @onclick='(() => ShowChapterDetailViewModal(status, "Status"))'>
                                                            <span class="fa fa-binoculars mr-2"></span>
                                                            <span>View</span>
                                                        </li>
                                                        <li class="col-red" @onclick="() => PrepareChapterDetailDelete(status)">
                                                            <span class="fa fa-trash-alt mr-2"></span>
                                                            <span>Delete</span>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {

                                            <div class="btn-ellipses float-left">
                                                @if (!(status.ComparisonIcon is null))
                                                {
                                                    @if (!(status.ComparisonResult == "Exact match"))
                                                    {
                                                        <div class="btn-dashed" @onclick="() => PrepareForComparison(status)"><span class="fa fa-@status.ComparisonIcon"></span></div>
                                                    }
                                                    else
                                                    {
                                                        <span class="fa fa-@status.ComparisonIcon"></span>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="spinner"></div>
                                                }

                                            </div>


                                        }

                                    }
                                    else
                                    {
                                        <div class="btn-ellipses float-left">
                                            <span class="fa fa-ellipsis-v"></span>
                                            <div class="ellipsis-menu">
                                                <ul>
                                                    <li class="col-main" @onclick='(() => ShowChapterDetailViewModal(status, "Status"))'>
                                                        <span class="fa fa-pencil-alt mr-2"></span>
                                                        <span>View</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    }
                                    <div class="data-item-sub">
                                        <span class="font-100"><span class="fa fa-battery-half mr-2"></span></span>@status.ChapterObject.Name
                                    </div>

                                    @if (status.ChapterObject.SuppressStep == "Y")
                                    {
                                        <div class="data-item-right suppress-step">
                                            <ModalTooltip Direction="left" Text="This status will end the Smartflow.">
                                                <span class="fa fa-flag-checkered"></span>
                                            </ModalTooltip>
                                        </div>
                                    }

                                    @if (sessionState.isAdminUser && !compareSystems)
                                    {

                                        <div class="data-item-right seq-change">
                                            <div @onclick='() => MoveSeq(status.ChapterObject, "Status", "Up")'><span class="fa fa-angle-up"></span></div>
                                            <div class="seq-no">@status.ChapterObject.SeqNo</div>
                                            <div @onclick='() => MoveSeq(status.ChapterObject, "Status", "Down")'><span class="fa fa-angle-down"></span></div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="data-item-right seq-change">
                                            <div class="seq-no">@status.ChapterObject.SeqNo</div>
                                        </div>
                                    }


                                </div>

                            </div>

                        }
                    </div>
                </div>

            }

            @if (navDisplay == "DataViews")
            {

                <div class="grid-chapter grid-chapter-dataviews">

                    <div class="grid-actions">

                        @if (!compareSystems)
                        {
                            @if (sessionState.isAdminUser)
                            {
                                <div class="btn-group">
                                    <button @onclick='() => PrepareDataViewForInsert(navDisplay)' class="btn btn-main btn-shadow" title="Add new data view"><i class="fa fa-plus"></i><span>New</span></button>
                                    <button @onclick='() => CondenseBlockNo("DataViews")' class="btn btn-main btn-shadow @(BlockNoIsValid() ? "invisible" : "")" title="Re-order Sequence Numbers"><i class="fa fa-sort-numeric-down"></i></button>
                                </div>
                            }
                        }

                        <ModalTooltip Direction="top" Text="Data Views to be made available in the chapter!">
                            <span class="info-icon">
                                <span class=" fa fa-info-circle fa-2x "></span>
                            </span>
                        </ModalTooltip>
                    </div>

                    <div class="@(sessionState.isAdminUser ? "grid-can-edit" : "") ">

                        @foreach (var vmdataView in ListVmDataViews)
                        {

                            <div class="row grid-row @(rowChanged == vmdataView.DataView.BlockNo ? "row-changed" : "" )">
                                <div class="col-12 data-item">
                                    @if (sessionState.isAdminUser)
                                    {

                                        <div class="btn-ellipses float-left">
                                            <span class="fa fa-ellipsis-v"></span>
                                            <div class="ellipsis-menu">
                                                <ul>
                                                    <li class="col-main" @onclick='() => PrepareDataViewForEdit(vmdataView, navDisplay)'>
                                                        <span class="fa fa-pencil-alt mr-2"></span>
                                                        <span>Edit</span>
                                                    </li>
                                                    <li class="col-main" @onclick='() => ShowDataViewDisplayModal(vmdataView)'>
                                                        <span class="fa fa-binoculars mr-2"></span>
                                                        <span>View</span>
                                                    </li>
                                                    <li class="col-red" @onclick='() => PrepareDataViewDelete(vmdataView)'>
                                                        <span class="fa fa-trash-alt mr-2"></span>
                                                        <span>Delete</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                    }
                                    else
                                    {
                                        <div class="btn-ellipses float-left">
                                            <span class="fa fa-ellipsis-v"></span>
                                            <div class="ellipsis-menu">
                                                <ul>
                                                    <li class="col-main" @onclick='() => ShowDataViewDisplayModal(vmdataView)'>
                                                        <span class="fa fa-binoculars mr-2"></span>
                                                        <span>View</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    }

                                    <div class="data-item-sub " title="@vmdataView.DataViewDisplayName.">
                                        @vmdataView.DataViewDisplayName
                                    </div>


                                    @if (!string.IsNullOrEmpty(vmdataView.DataView.DisplayName))
                                    {
                                        <div class="data-item-right hidden-md-down">
                                            <ModalTooltip Direction="top" Text=@("Template: " + vmdataView.DataView.ViewName) Class="w-3">
                                                <span class="fa fa-clone"></span>
                                            </ModalTooltip>
                                        </div>
                                    }

                                    @if (sessionState.isAdminUser && !compareSystems)
                                    {

                                        <div class="data-item-right seq-change">
                                            <div @onclick='() => MoveBlockNo(vmdataView.DataView, "DataViews", "Up")'><span class="fa fa-angle-up"></span></div>
                                            <div class="seq-no">@vmdataView.DataView.BlockNo</div>
                                            <div @onclick='() => MoveBlockNo(vmdataView.DataView, "DataViews", "Down")'><span class="fa fa-angle-down"></span></div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="data-item-right seq-change">
                                            <div class="seq-no">@vmdataView.DataView.BlockNo</div>
                                        </div>
                                    }


                                </div>

                            </div>

                        }
                    </div>
                </div>


            }


            @if (navDisplay == "TickerMessages")
            {

                <div class="grid-chapter grid-chapter-messages">

                    <div class="grid-actions">

                        @if (!compareSystems)
                        {
                            @if (sessionState.isAdminUser)
                            {
                                <div class="btn-group">
                                    @if (ListVmTickerMessages.Count() < 3)
                                    {
                                        <button @onclick='() => PrepareTickerMessageForInsert(navDisplay)' class="btn btn-main btn-shadow" title="Add new ticker message"><i class="fa fa-plus"></i><span>New</span></button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-main btn-shadow" title="Cannot add new ticker message - Max number of messages reached" disabled><i class="fa fa-plus"></i><span>New</span></button>
                                    }
                                    <button @onclick='() => CondenseBlockNo("TickerMessages")' class="btn btn-main btn-shadow @(BlockNoIsValid() ? "invisible" : "")" title="Re-order Sequence Numbers"><i class="fa fa-sort-numeric-down"></i></button>
                                </div>
                            }
                        }

                        <ModalTooltip Direction="top" Text="Ticker Message to be made visible on the smartflow screen!">
                            <span class="info-icon">
                                <span class=" fa fa-info-circle fa-2x "></span>
                            </span>
                        </ModalTooltip>
                    </div>

                    <div class="@(sessionState.isAdminUser ? "grid-can-edit" : "") ">
                        <div class="row grid-header invisible-md-down">
                            <div class="data-item ">
                                <div class="data-item-sub">
                                    Message
                                </div>
                            </div>
                            <div class="data-item ">
                                <div class="data-item-sub">
                                    From Date
                                </div>
                            </div>
                            <div class="data-item ">
                                <div class="data-item-sub">
                                    To Date
                                </div>
                            </div>
                        </div>
                        @foreach (var vmtickerMessages in ListVmTickerMessages)
                        {

                            <div class="row grid-row @(rowChanged == vmtickerMessages.Message.SeqNo ? "row-changed" : "" )">
                                <div class="data-item">
                                    @if (sessionState.isAdminUser)
                                    {

                                        <div class="btn-ellipses float-left">
                                            <span class="fa fa-ellipsis-v"></span>
                                            <div class="ellipsis-menu">
                                                <ul>
                                                    <li class="col-main" @onclick='() => PrepareTickerMessageForEdit(vmtickerMessages, navDisplay)'>
                                                        <span class="fa fa-pencil-alt mr-2"></span>
                                                        <span>Edit</span>
                                                    </li>
                                                    <li class="col-red" @onclick='() => PrepareTickerMessageDelete(vmtickerMessages)'>
                                                        <span class="fa fa-trash-alt mr-2"></span>
                                                        <span>Delete</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                    }
                                    else
                                    {
                                        <div class="btn-ellipses float-left">
                                            <span class="fa fa-ellipsis-v"></span>
                                            <div class="ellipsis-menu">
                                                <ul>
                                                    <li class="col-main" @onclick='() => ShowTickerMessageDisplayModal(vmtickerMessages)'>
                                                        <span class="fa fa-binoculars mr-2"></span>
                                                        <span>View</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    }

                                    <div class="data-item-sub " title="@vmtickerMessages.Message.Message">
                                        @vmtickerMessages.Message.Message
                                    </div>
                                    @if (sessionState.isAdminUser && !compareSystems)
                                    {

                                        <div class="data-item-right seq-change">
                                            <div @onclick='() => MoveMessageSeqNo(vmtickerMessages.Message, "TickerMessages", "Up")'><span class="fa fa-angle-up"></span></div>
                                            <div class="seq-no">@vmtickerMessages.Message.SeqNo</div>
                                            <div @onclick='() => MoveMessageSeqNo(vmtickerMessages.Message, "TickerMessages", "Down")'><span class="fa fa-angle-down"></span></div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="data-item-right">
                                            <div class="seq-no">@vmtickerMessages.Message.SeqNo</div>
                                        </div>
                                    }

                                </div>
                                @if (!string.IsNullOrEmpty(vmtickerMessages.Message.FromDate))
                                {
                                    <div class="hidden-md-down data-item ">
                                        <div class="data-item-sub">@(DateTime.ParseExact(vmtickerMessages.Message.FromDate, "yyyyMMdd", CultureInfo.InvariantCulture).ToString("dd/MM/yyyy"))</div>
                                    </div>
                                }
                                else
                                {
                                    <div class="hidden-md-down data-item ">
                                        <div class="data-item-sub">
                                        </div>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(vmtickerMessages.Message.ToDate))
                                {
                                    <div class="hidden-md-down data-item ">
                                        <div class="data-item-sub font-85 pl-3">@(DateTime.ParseExact(vmtickerMessages.Message.ToDate, "yyyyMMdd", CultureInfo.InvariantCulture).ToString("dd/MM/yyyy"))</div>
                                    </div>
                                }
                                else
                                {
                                    <div class="hidden-md-down data-item ">
                                        <div class="data-item-sub">
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>


            }

            @if (navDisplay == "Background")
            {
                <div class="grid-chapter grid-chapter-background">

                    <div class="detail-group-box">
                        <div id="selected-bg-items">
                            <div id="selected-image">
                                <div class="selected-thumbnail ">
                                    @if (!string.IsNullOrEmpty(selectedChapter.BackgroundImageName))
                                    {
                                        <div>Selected Image: <span class="font-85">@selectedChapter.BackgroundImageName</span></div>
                                        <img src="@selectedChapter.BackgroundImage.Replace("/wwwroot","")" alt="" class="img-thumbnail ml-2" />
                                    }
                                    else
                                    {
                                        <label class="d-block col-grey">No Image Selected</label>
                                        <img src="/images/BackgroundImages/NoImage.jpg" alt="" class="img-thumbnail ml-2" />

                                    }
                                </div>
                                <div class="hidden-lg-down form-group-inline" >
                                    <label style="margin-right: 10px">Preview Image</label>
                                    <label class="switch">
                                        <input type="checkbox" @bind="PreviewChapterImage">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>

                            <div style="margin-left: 50px">
                                <label>Background Colour</label>
                                <select @bind="selectColour"
                                        style="background-color: @getHTMLColourFromAndroid(ListChapterColours.Where(C => C.ColourName == selectColour).Select(C => C.ColourCode).FirstOrDefault())"
                                        class="form-control form-control-lg">
                                    @foreach (var colour in ListChapterColours)
                                    {
                                        <option style="background-color: @getHTMLColourFromAndroid(colour.ColourCode)" value="@(colour.ColourCode.Contains("#") ? colour.ColourName : colour.ColourCode)">
                                            @colour.ColourName

                                        </option>
                                    }
                                </select>


                            </div>
                        </div>

                        <div class="custom-file">
                            <InputFile multiple OnChange="HandleBgImageFileSelection" class="custom-file-input" id="customFileInput"></InputFile>
                            <label class="custom-file-label" for="customInput">Upload images</label>
                        </div>



                        <div class="grid-can-edit chapter-scroll-list">
                            <div class="thumbnail-list">
                                @foreach (var fileDesc in ListFilesForBgImages.ToList().OrderBy(F => F.FileName))
                                {

                                    <div class="thumbnail-item @(!string.IsNullOrEmpty(selectedChapter.BackgroundImageName) && fileDesc.FileName == selectedChapter.BackgroundImageName ? "active" : "")">
                                        <img src="@fileDesc.FileURL.Replace("/wwwroot","")" alt="" class="img-thumbnail" />
                                        <label>@fileDesc.FileName</label>
                                        <div class="thumbnail-options">
                                            <button @onclick='(() => PrepareBgImageForDelete(fileDesc))' class="btn col-grey" title="Delete this image"><i class="fa fa-trash"></i></button>
                                            @if (!string.IsNullOrEmpty(selectedChapter.BackgroundImageName) && fileDesc.FileName == selectedChapter.BackgroundImageName)
                                            {
                                                <button @onclick='() => SelectBgImage(new FileManagement.FileClassObjects.FileDesc { FileName = "", FileURL = "" })' class="btn " title="Deselect this image"><i class="fa fa-times"></i></button>
                                            }
                                            else
                                            {
                                                <button @onclick='() => SelectBgImage(fileDesc)' class="btn " title="Use this image"><i class="fa fa-check"></i></button>
                                            }
                                        </div>
                                    </div>

                                }
                            </div>
                        </div>



                    </div>
                </div>

            }

            @if (navDisplay == "Backups")
            {
                <div class="grid-chapter grid-chapter-backups">
                    <div class="detail-group-box" id="form-controls-json">
                        <h5>Backup and Recovery: @selectedChapter.Name</h5>
                        <div class="btn-group mt-2">
                            <button @onclick="WriteChapterJSONToFile" class="btn btn-main btn-shadow"><i class="fa fa-save"></i><span>New Backup</span></button>
                        </div>
                        <div class="alert alert-danger mt-3 @(string.IsNullOrEmpty(alertMsgJSOM) ? "hidden" : "")">@alertMsgJSOM</div>

                        <div class="custom-file">
                            <InputFile multiple OnChange="HandleBackupFileSelection" class="custom-file-input" id="customFileInput"></InputFile>
                            <label class="custom-file-label" for="customInput">Upload backup files</label>
                        </div>



                        <div class="grid-can-edit chapter-scroll-list">
                            @foreach (var fileDesc in ListFilesForBackups.Where(F => F.FilePath.Contains(".txt") || F.FilePath.Contains(".JSON")).ToList().OrderByDescending(F => F.FileDate))
                            {
                                <div class="row grid-row grid-row-sm">
                                    <div class="data-item">
                                        <div class="btn-ellipses float-left">
                                            <span class="fa fa-ellipsis-v"></span>
                                            <div class="ellipsis-menu">
                                                <ul>
                                                    <li class="col-main" @onclick='(() => ReadBackUpFile(fileDesc.FilePath))'>
                                                        <span class="fa fa-window-restore mr-2"></span>
                                                        <span>Restore</span>
                                                    </li>
                                                    <li class="col-main" @onclick='(() => DownloadFile(fileDesc))'>
                                                        <span class="fa fa-download mr-2"></span>
                                                        <span>Download</span>
                                                    </li>
                                                    <li class="col-main" @onclick='(() => PrepareBackUpForDelete(fileDesc))'>
                                                        <span class="fa fa-trash-alt mr-2"></span>
                                                        <span>Delete</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="data-item-sub">
                                            @fileDesc.FileName
                                        </div>
                                    </div>
                                    <div class="data-item ">
                                        <div class="data-item-sub">
                                            @fileDesc.FileDate.ToString("dd MMM yyyy")
                                        </div>
                                    </div>


                                </div>
                            }
                        </div>



                    </div>
                </div>

            }


        


        }
    </div>

}